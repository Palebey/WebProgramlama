@page
@model web.Pages.Planlarim.IndexModel
@{
    ViewData["Title"] = "Gelişim Paneli";
}

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
    /* AI Çıktısı için Özel Stil */
    .ai-content h1, .ai-content h2, .ai-content h3 {
        color: #ffc107;
        margin-top: 15px;
        font-size: 1.2rem;
    }

    .ai-content ul {
        padding-left: 20px;
        color: #e0e0e0;
    }

    .ai-content strong {
        color: #0dcaf0;
    }

    .ai-content p {
        margin-bottom: 10px;
        line-height: 1.6;
    }

    .scrollable-content {
        max-height: 500px;
        overflow-y: auto;
    }
        /* Scrollbar Tasarımı */
        .scrollable-content::-webkit-scrollbar {
            width: 8px;
        }

        .scrollable-content::-webkit-scrollbar-track {
            background: #212529;
        }

        .scrollable-content::-webkit-scrollbar-thumb {
            background: #6c757d;
            border-radius: 4px;
        }
</style>

<div class="container-fluid mt-5 pt-4">
    <div class="row g-4">

        <div class="col-lg-4">

            <div class="card bg-dark border-secondary text-white mb-4 shadow">
                <div class="card-body text-center">
                    <div class="mb-3">
                        <span class="material-symbols-outlined fs-1 text-warning p-3 rounded-circle bg-warning bg-opacity-10 border border-warning">person</span>
                    </div>
                    <h5 class="card-title">@User.Identity?.Name</h5>
                    <p class="text-muted small">Spor Salonu Üyesi</p>
                    <div class="d-flex justify-content-center gap-2 mt-3">
                        <a asp-page="/Index" class="btn btn-sm btn-outline-primary"><i class="bi bi-plus-lg"></i> Yeni Plan Oluştur</a>
                    </div>
                </div>
            </div>

            <div class="card bg-dark border-secondary text-white mb-4 shadow h-100">
                <div class="card-header border-secondary d-flex justify-content-between align-items-center bg-transparent">
                    <h6 class="m-0 text-info"><i class="bi bi-calendar-event"></i> Randevularım</h6>
                </div>
                <div class="card-body p-0">
                    <div id="randevuListesi" class="p-3">
                        <div class="text-center text-muted py-3">
                            <div class="spinner-border spinner-border-sm text-info" role="status"></div> Yükleniyor...
                        </div>
                    </div>
                </div>
            </div>

            <div class="card bg-dark border-secondary text-white shadow">
                <div class="card-header border-secondary bg-transparent">
                    <h6 class="m-0 text-secondary"><i class="bi bi-clock-history"></i> Analiz Geçmişi</h6>
                </div>
                <div class="list-group list-group-flush">
                    @if (Model.GecmisPlanlar != null && Model.GecmisPlanlar.Any())
                    {
                        @foreach (var plan in Model.GecmisPlanlar)
                        {
                            <div class="list-group-item bg-dark text-white border-secondary d-flex justify-content-between align-items-center">
                                <div>
                                    <small class="d-block text-warning">@plan.OlusturulmaTarihi.ToString("dd MMM yyyy HH:mm")</small>
                                    <span class="badge bg-secondary text-dark" style="font-size: 0.7rem;">@plan.Hedef</span>
                                </div>
                                @if (plan == Model.EnSonPlan)
                                {
                                    <i class="bi bi-check-circle-fill text-success"></i>
                                }
                            </div>
                        }
                    }
                    else
                    {
                        <div class="p-3 text-center text-muted small">Henüz kayıtlı bir planınız yok.</div>
                    }
                </div>
            </div>
        </div>

        <div class="col-lg-8">
            @if (Model.EnSonPlan != null)
            {
                <div class="card bg-dark border-warning text-white shadow-lg h-100">
                    <div class="card-header bg-warning bg-opacity-10 border-warning d-flex justify-content-between align-items-center">
                        <h4 class="m-0 text-warning"><i class="bi bi-stars"></i> En Güncel Analizin</h4>
                        <span class="badge bg-warning text-dark">@Model.EnSonPlan.OlusturulmaTarihi.ToString("dd.MM.yyyy")</span>
                    </div>

                    <div class="card-body">
                        <div class="row mb-4 g-3">
                            <div class="col-md-3 col-6">
                                <div class="p-2 border border-secondary rounded text-center bg-black bg-opacity-25">
                                    <small class="text-muted d-block">Hedef</small>
                                    <span class="fw-bold text-info">@Model.EnSonPlan.Hedef</span>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="p-2 border border-secondary rounded text-center bg-black bg-opacity-25">
                                    <small class="text-muted d-block">Mevcut Kilo</small>
                                    <span class="fw-bold">@Model.EnSonPlan.Kilo kg</span>
                                </div>
                            </div>
                            <div class="col-md-3 col-6">
                                <div class="p-2 border border-secondary rounded text-center bg-black bg-opacity-25">
                                    <small class="text-muted d-block">Boy</small>
                                    <span class="fw-bold">@Model.EnSonPlan.Boy cm</span>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            @if (!string.IsNullOrEmpty(Model.EnSonPlan.ResimUrl))
                            {
                                <div class="col-md-4 mb-3">
                                    <div class="card bg-black border-secondary">
                                        <img src="@Model.EnSonPlan.ResimUrl" class="card-img-top" alt="Analiz Edilen Görsel" style="object-fit: cover; height: 300px;">
                                        <div class="card-footer border-secondary text-center">
                                            <small class="text-muted">Analiz Edilen Görsel</small>
                                        </div>
                                    </div>
                                </div>
                            }

                            <div class="@(string.IsNullOrEmpty(Model.EnSonPlan.ResimUrl) ? "col-12" : "col-md-8")">
                                <div class="p-3 rounded border border-secondary bg-black bg-opacity-25 scrollable-content">
                                    <div id="rawMarkdown" class="d-none">@Model.EnSonPlan.ProgramMetni</div>
                                    <div id="aiResultHtml" class="ai-content"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            }
            else
            {
                <div class="card bg-dark border-secondary text-white h-100 d-flex align-items-center justify-content-center p-5 text-center">
                    <span class="material-symbols-outlined display-1 text-secondary mb-3">fitness_center</span>
                    <h3>Henüz Başlamadın Mı?</h3>
                    <p class="text-muted mb-4">Sana özel bir antrenman ve beslenme programı oluşturmak için yapay zekayı kullan.</p>
                    <a asp-page="/Index" class="btn btn-lg btn-primary">Hemen Plan Oluştur</a>
                </div>
            }
        </div>
    </div>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function () {

        // 1. MARKDOWN ÇEVİRİSİ
        // Veritabanından gelen Markdown metnini alıp HTML'e çeviriyoruz
        const rawText = document.getElementById('rawMarkdown');
        const targetDiv = document.getElementById('aiResultHtml');

        if (rawText && targetDiv) {
            // marked kütüphanesi ile çevir
            targetDiv.innerHTML = marked.parse(rawText.textContent);
        }

        // 2. RANDEVU API ÇAĞRISI
        fetch('/api/RandevuApi/GetMyAppointments')
            .then(response => response.json())
            .then(data => {
                const liste = document.getElementById('randevuListesi');
                liste.innerHTML = "";

                if (data.length === 0) {
                    liste.innerHTML = '<div class="alert alert-dark text-center border-secondary text-muted"><small>Planlanmış randevu yok.</small></div>';
                    return;
                }

                let html = `<div class="table-responsive"><table class="table table-dark table-hover table-sm mb-0" style="font-size: 0.9rem;">
                                <thead><tr><th class="text-secondary">Tarih</th><th class="text-secondary">Antrenör</th><th class="text-secondary">Durum</th></tr></thead>
                                <tbody>`;

                data.forEach(item => {
                    // Tarihi biraz daha okunaklı formatlayalım
                    const dateObj = new Date(item.tarih);
                    const dateStr = dateObj.toLocaleDateString('tr-TR', { day: 'numeric', month: 'short' });
                    const timeStr = dateObj.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' });

                    html += `<tr>
                                <td>${dateStr} <small class="text-muted">${timeStr}</small></td>
                                <td>${item.antrenor}</td>
                                <td><span class="badge bg-${item.durumRenk}">${item.durum}</span></td>
                             </tr>`;
                });

                html += `</tbody></table></div>`;
                liste.innerHTML = html;
            })
            .catch(err => {
                const liste = document.getElementById('randevuListesi');
                if(liste) liste.innerHTML = '<span class="text-danger small">Randevu verisi alınamadı.</span>';
                console.error(err);
            });
    });
</script>