@page
@model IndexModel
@{
    ViewData["Title"] = "Ana Sayfa";
}

<section class="hero-section d-flex align-items-center justify-content-center py-5 mt-5">
    <div class="container text-center">
        <div class="hero-card p-4 p-md-5 rounded-4 shadow-lg mt-5">
            <div class="badge bg-primary bg-opacity-10 text-primary border border-primary mb-3">
                <span class="material-symbols-outlined fs-6 align-middle">auto_awesome</span> AI Destekli Analiz
            </div>
            <h1 class="display-4 fw-bold text-white mb-3">Gelecekteki Seni <span class="text-gradient">Tasarla</span></h1>
            <p class="text-secondary mb-5">Vücut ölçülerinizi ve fotoğrafınızı yükleyin, yapay zeka size en uygun planı çıkarsın.</p>

            <div class="card bg-dark border-secondary text-start p-4">
                <ul class="nav nav-tabs border-bottom-0 mb-4" id="myTab" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active text-primary fw-bold" type="button">Vücut Bilgileri</button>
                    </li>
                </ul>

                <form id="aiForm" enctype="multipart/form-data">
                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <label class="form-label text-uppercase text-muted fs-7">Cinsiyet</label>
                            <select class="form-select bg-dark text-light border-secondary" id="gender">
                                <option value="Erkek">Erkek</option>
                                <option value="Kadın">Kadın</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-uppercase text-muted fs-7">Yaş</label>
                            <input type="number" class="form-control bg-dark text-light border-secondary" id="age" placeholder="Örn: 25" min="10" max="90">
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-uppercase text-muted fs-7">Hedef</label>
                            <select class="form-select bg-dark text-light border-secondary" id="goal">
                                <option value="Yağ Yakımı">Yağ Yakımı</option>
                                <option value="Kas Kazanımı">Kas Kazanımı</option>
                                <option value="Dayanıklılık">Dayanıklılık</option>
                            </select>
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label text-uppercase text-muted fs-7">Boy (cm)</label>
                            <div class="input-group">
                                <span class="input-group-text bg-dark border-secondary text-muted material-symbols-outlined">height</span>
                                <input type="number" class="form-control bg-dark text-light border-secondary" id="height" placeholder="Örn: 175" min="100" max="250">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-uppercase text-muted fs-7">Kilo (kg)</label>
                            <div class="input-group">
                                <span class="input-group-text bg-dark border-secondary text-muted material-symbols-outlined">monitor_weight</span>
                                <input type="number" class="form-control bg-dark text-light border-secondary" id="weight" placeholder="Örn: 70" min="30" max="300">
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label text-uppercase text-muted fs-7">Vücut Durumu / Ekipman Fotosu (İsteğe Bağlı)</label>
                        <input type="file" class="form-control bg-dark text-light border-secondary" id="uploadedImage" accept="image/*">
                    </div>

                    <div class="mt-4 pt-3 border-top border-secondary d-flex justify-content-between align-items-center">
                        <button type="submit" id="btnGonder" class="btn btn-primary btn-lg px-5 d-flex align-items-center gap-2 ms-auto">
                            <span id="loadingSpinner" class="spinner-border spinner-border-sm d-none"></span>
                            <span id="btnText"><span class="material-symbols-outlined">auto_awesome</span> Planı Oluştur</span>
                        </button>
                    </div>
                </form>
            </div>

            <div id="resultArea" class="mt-5 d-none text-start">
                <div class="card bg-dark border-success">
                    <div class="card-header bg-success text-white">
                        <h5 class="m-0"><i class="bi bi-check-circle"></i> AI Tarafından Hazırlanan Plan</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <pre id="aiOutput" class="text-light" style="white-space: pre-wrap; font-family: sans-serif;"></pre>
                            </div>
                            <div class="col-md-4">
                                <img id="resultImage" src="" class="img-fluid rounded d-none border border-success" />
                                <small class="text-muted d-block mt-2 text-center">Yüklenen görsel analiz için kaydedildi.</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</section>

<section class="py-5">
    <div class="container">
    </div>
</section>

@section Scripts {
    <script>
        document.getElementById('aiForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Elementleri seç
            const btn = document.getElementById('btnGonder');
            const spinner = document.getElementById('loadingSpinner');
            const btnText = document.getElementById('btnText');

            // Yükleniyor durumuna geç
            btn.disabled = true;
            spinner.classList.remove('d-none');
            btnText.textContent = " Analiz Ediliyor...";

            // Eski sonuçları gizle
            document.getElementById('resultArea').classList.add('d-none');

            // Formdaki verileri topla
            const gender = document.getElementById('gender').value;
            const age = document.getElementById('age').value;
            const goal = document.getElementById('goal').value;
            const height = document.getElementById('height').value;
            const weight = document.getElementById('weight').value;

            // Yapay zeka için metin oluştur (Controller'a gidecek IstekMetni)
            let promptText = `Cinsiyetim: ${gender}, Yaşım: ${age}, Hedefim: ${goal}.`;
            if(height) promptText += ` Boyum: ${height}cm.`;
            if(weight) promptText += ` Kilom: ${weight}kg.`;

            // FormData oluştur
            const formData = new FormData();
            formData.append('IstekMetni', promptText); // Oluşturduğumuz metin

            if(height) formData.append('Boy', height);
            if(weight) formData.append('Kilo', weight);

            const fileInput = document.getElementById('uploadedImage');
            if(fileInput.files[0]) {
                formData.append('Gorsel', fileInput.files[0]);
            }

            try {
                // Controller'a istek at
                const response = await fetch('/api/yapayzeka/plan-olustur', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    const errData = await response.json();
                    throw new Error(errData.mesaj || "Sunucu hatası");
                }

                const result = await response.json();

                if (result.success) {
                    // Sonucu göster
                    document.getElementById('resultArea').classList.remove('d-none');
                    document.getElementById('aiOutput').textContent = result.data;

                    const img = document.getElementById('resultImage');
                    if (result.imageUrl) {
                        img.src = result.imageUrl;
                        img.classList.remove('d-none');
                    } else {
                        img.classList.add('d-none');
                    }

                    // Sonuca doğru kaydır
                    document.getElementById('resultArea').scrollIntoView({ behavior: 'smooth' });
                }

            } catch (error) {
                console.error('Hata:', error);
                alert("Hata oluştu: " + error.message);
            } finally {
                // Butonu eski haline getir
                btn.disabled = false;
                spinner.classList.add('d-none');
                btnText.innerHTML = '<span class="material-symbols-outlined">auto_awesome</span> Planı Oluştur';
            }
        });
    </script>
}