@page
@model IndexModel
@{
    ViewData["Title"] = "AI Antrenör";
}

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<style>
    /* AI Çıktısı için Özel Tasarım */
    #aiOutput ul, #aiOutput ol {
        margin-left: 20px;
        margin-bottom: 1rem;
        color: #e0e0e0;
    }

    #aiOutput h1, #aiOutput h2, #aiOutput h3 {
        color: #ffc107; /* Başlıklar Sarı */
        margin-top: 1.5rem;
        margin-bottom: 1rem;
        font-weight: bold;
    }

    #aiOutput p {
        margin-bottom: 1rem;
        line-height: 1.6;
    }

    #aiOutput strong {
        color: #0dcaf0; /* Kalın yazılar Mavi */
    }
</style>

<section class="hero-section d-flex align-items-center justify-content-center py-5 mt-5">
    <div class="container text-center">
        <div class="hero-card p-4 p-md-5 rounded-4 shadow-lg mt-5">

            <div class="badge bg-primary bg-opacity-10 text-primary border border-primary mb-3">
                <span class="material-symbols-outlined fs-6 align-middle">bolt</span> Groq AI Powered
            </div>

            <h1 class="display-4 fw-bold text-white mb-3">Yapay Zeka <span class="text-gradient">Antrenörün</span></h1>
            <p class="text-secondary mb-5">Hedeflerini ve vücut ölçülerini gir, saniyeler içinde sana özel antrenman ve beslenme programını al.</p>

            <div class="card bg-dark border-secondary text-start p-4">
                <form id="aiForm" enctype="multipart/form-data">
                    <div class="row g-3 mb-3">
                        <div class="col-md-4">
                            <label class="form-label text-uppercase text-muted fs-7">Cinsiyet</label>
                            <select class="form-select bg-dark text-light border-secondary" id="gender">
                                <option value="Erkek">Erkek</option>
                                <option value="Kadın">Kadın</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-uppercase text-muted fs-7">Yaş</label>
                            <input type="number" class="form-control bg-dark text-light border-secondary" id="age" placeholder="Örn: 23" min="10" max="90" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label text-uppercase text-muted fs-7">Hedef</label>
                            <select class="form-select bg-dark text-light border-secondary" id="goal">
                                <option value="Yağ Yakımı ve Definasyon">Yağ Yakımı</option>
                                <option value="Kas Kütlesi Kazanımı (Bulk)">Kas Kazanımı</option>
                                <option value="Kondisyon ve Dayanıklılık">Dayanıklılık</option>
                                <option value="Powerlifting / Güç Odaklı">Güç Artışı</option>
                            </select>
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-md-6">
                            <label class="form-label text-uppercase text-muted fs-7">Boy (cm)</label>
                            <div class="input-group">
                                <span class="input-group-text bg-dark border-secondary text-muted material-symbols-outlined">height</span>
                                <input type="number" class="form-control bg-dark text-light border-secondary" id="height" placeholder="180" min="100" max="250">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label text-uppercase text-muted fs-7">Kilo (kg)</label>
                            <div class="input-group">
                                <span class="input-group-text bg-dark border-secondary text-muted material-symbols-outlined">monitor_weight</span>
                                <input type="number" class="form-control bg-dark text-light border-secondary" id="weight" placeholder="75" min="30" max="300">
                            </div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label text-uppercase text-muted fs-7">Vücut Formu veya Ekipman Fotosu (Opsiyonel)</label>
                        <div class="d-flex gap-2 align-items-center">
                            <input type="file" class="form-control bg-dark text-light border-secondary" id="uploadedImage" accept="image/*">
                            <span class="text-muted fs-7" title="AI fotoğrafı analiz edecek ve hedefine ulaştığındaki tahmini görünümünü çizecek."><i class="bi bi-info-circle"></i></span>
                        </div>
                    </div>

                    <div class="mt-4 pt-3 border-top border-secondary">
                        <button type="submit" id="btnGonder" class="btn btn-primary btn-lg w-100 d-flex align-items-center justify-content-center gap-2">
                            <span id="loadingSpinner" class="spinner-border spinner-border-sm d-none"></span>
                            <span id="btnText">Programı Oluştur</span>
                        </button>
                    </div>
                </form>
            </div>

            <div id="resultArea" class="mt-5 d-none text-start">
                <div class="card bg-dark border-primary shadow-lg">
                    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
                        <h5 class="m-0"><i class="bi bi-robot"></i> Senin İçin Hazırlanan Plan</h5>
                        <small class="badge bg-white text-primary">AI Generated</small>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12">
                                <div id="aiOutput" class="text-light fs-6"></div>
                            </div>

                            <div class="col-md-12 mt-4 text-center border-top border-secondary pt-3 d-none" id="imageContainer">
                                <p class="text-warning mb-2 fw-bold"><i class="bi bi-stars"></i> Hedeflenen Fiziksel Değişim (AI Simülasyonu)</p>
                                <img id="resultImage" src="" class="img-fluid rounded border border-warning shadow" style="max-height: 400px; object-fit: contain;" />
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </div>
</section>

@section Scripts {
    <script>
        document.getElementById('aiForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            // Elementleri Seç
            const btn = document.getElementById('btnGonder');
            const spinner = document.getElementById('loadingSpinner');
            const btnText = document.getElementById('btnText');
            const resultArea = document.getElementById('resultArea');
            const aiOutput = document.getElementById('aiOutput');
            const imgContainer = document.getElementById('imageContainer');
            const resultImg = document.getElementById('resultImage');

            // Yükleniyor Animasyonunu Başlat
            btn.disabled = true;
            spinner.classList.remove('d-none');
            // Kullanıcıyı bekletirken ne yaptığımızı söylüyoruz
            btnText.textContent = " Analiz Ediliyor ve Çiziliyor... (30sn)";
            resultArea.classList.add('d-none');

            // Form Verilerini Topla
            const gender = document.getElementById('gender').value;
            const age = document.getElementById('age').value;
            const goal = document.getElementById('goal').value;
            const height = document.getElementById('height').value;
            const weight = document.getElementById('weight').value;

            // Prompt Oluştur
            let promptText = `Cinsiyet: ${gender}, Yaş: ${age}, Hedef: ${goal}.`;
            if(height) promptText += ` Boy: ${height}cm.`;
            if(weight) promptText += ` Kilo: ${weight}kg.`;

            const formData = new FormData();
            formData.append('IstekMetni', promptText);
            if(height) formData.append('Boy', height);
            if(weight) formData.append('Kilo', weight);

            const fileInput = document.getElementById('uploadedImage');
            if(fileInput.files[0]) {
                formData.append('Gorsel', fileInput.files[0]);
            }

            try {
                // API İsteği Gönder
                const response = await fetch('/api/yapayzeka/plan-olustur', {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    let errorMessage = "Sunucu hatası";
                    try {
                        const errData = await response.json();
                        errorMessage = errData.mesaj || errData.detay || JSON.stringify(errData);
                    } catch (parseError) {
                        errorMessage = await response.text();
                    }
                    throw new Error(errorMessage);
                }

                const result = await response.json();

                if (result.success) {
                    // Sonuç Alanını Göster
                    resultArea.classList.remove('d-none');

                    // Markdown'ı HTML'e çevir
                    aiOutput.innerHTML = marked.parse(result.data);

                    // Resim varsa göster
                    if (result.imageUrl) {
                        resultImg.src = result.imageUrl;
                        imgContainer.classList.remove('d-none');
                    } else {
                        imgContainer.classList.add('d-none');
                    }

                    // Sayfayı sonuca kaydır
                    resultArea.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }

            } catch (error) {
                console.error(error);
                alert("Bir hata oluştu: " + error.message);
            } finally {
                // İşlem bitince butonu eski haline getir
                btn.disabled = false;
                spinner.classList.add('d-none');
                btnText.textContent = "Programı Oluştur";
            }
        });
    </script>
}